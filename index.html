<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Drug Interaction Checker</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    textarea { width: 100%; height: 80px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #bbb; padding: 0.5rem; text-align: left; }
    th { background: #eee; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Verificar Interações</h1>
  <p>Digite um fármaco por linha (ex: cannabidiol):</p>
  <textarea id="drugsInput" placeholder="cannabidiol&#10;warfarin"></textarea>
  <button id="checkBtn">Verificar Interações</button>
  <p id="status"></p>
  <table id="resultsTable" hidden>
    <thead>
      <tr>
        <th>Fármaco A</th>
        <th>Fármaco B</th>
        <th>Severidade</th>
        <th>Descrição</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const statusEl = document.getElementById('status');
    const table    = document.getElementById('resultsTable');
    const tbody    = table.querySelector('tbody');

    // 1) Mapeia nome → RxCUI, já tratando resposta "Not found"
    async function getRxCUI(drug) {
      const url = 'https://rxnav.nlm.nih.gov/REST/rxcui.json?name='
                + encodeURIComponent(drug.trim());
      const res = await fetch(url);

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`Erro ao buscar "${drug}": ${txt}`);
      }

      let data;
      try {
        data = await res.json();
      } catch {
        throw new Error(`Resposta inválida ao buscar "${drug}"`);
      }

      const ids = data.idGroup?.rxnormId;
      if (!ids?.length) {
        throw new Error(`"${drug}" não encontrado no RxNorm`);
      }
      return ids[0];
    }

    // 2) Consulta interações, tratando erros não-JSON e mostrando a URL no console
    async function fetchInteractions(rxcuis) {
      const rxcuisParam  = encodeURIComponent(rxcuis.join('+'));
      const sourcesParam = encodeURIComponent('ONCHigh,DrugBank');
      const url = `https://rxnav.nlm.nih.gov/REST/interaction/list.json`
                + `?rxcuis=${rxcuisParam}`
                + `&sources=${sourcesParam}`;

      console.log('>>> URL de interação:', url);

      const res = await fetch(url);

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`Erro na API de interações: ${txt}`);
      }

      let data;
      try {
        data = await res.json();
      } catch {
        throw new Error('Resposta inválida da API de interações');
      }

      if (data.error) {
        throw new Error(`API retornou erro: ${data.error}`);
      }

      return data
        .interactionTypeGroup
        .flatMap(g => g.fullInteractionTypeGroup || [])
        .flatMap(g =>
          g.interactionType.map(it => ({
            a:        it.minConcept[0].name,
            b:        it.minConcept[1].name,
            severity: it.interactionPair[0].severity,
            desc:     it.interactionPair[0].description
          }))
        );
    }

    // 3) Listener do botão
    document.getElementById('checkBtn').addEventListener('click', async () => {
      statusEl.textContent = '';
      statusEl.className   = '';
      tbody.innerHTML      = '';
      table.hidden         = true;

      const drugs = document.getElementById('drugsInput').value
                     .split('\n')
                     .map(s => s.trim())
                     .filter(Boolean);

      if (drugs.length < 2) {
        statusEl.textContent = 'Digite pelo menos duas drogas.';
        statusEl.className   = 'error';
        return;
      }

      try {
        statusEl.textContent = 'Buscando RxCUI…';
        const rxcuis = await Promise.all(drugs.map(getRxCUI));

        statusEl.textContent = 'Consultando interações…';
        const interactions = await fetchInteractions(rxcuis);

        if (!interactions.length) {
          statusEl.textContent = 'Nenhuma interação encontrada.';
          return;
        }

        interactions.forEach(i => {
          tbody.insertAdjacentHTML('beforeend', `
            <tr>
              <td>${i.a}</td>
              <td>${i.b}</td>
              <td>${i.severity}</td>
              <td>${i.desc}</td>
            </tr>
          `);
        });

        table.hidden = false;
        statusEl.textContent = `Encontradas ${interactions.length} interações.`;

      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.className   = 'error';
      }
    });
  </script>
</body>
</html>
