<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Drug Interaction Checker</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    textarea { width: 100%; height: 80px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #bbb; padding: 0.5rem; text-align: left; }
    th { background: #eee; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Verificar Interações</h1>
  <p>Digite um fármaco por linha (ex: cannabidiol):</p>
  <textarea id="drugsInput" placeholder="cannabidiol&#10;warfarin"></textarea>
  <button id="checkBtn">Verificar Interações</button>
  <p id="status"></p>
  <table id="resultsTable" hidden>
    <thead>
      <tr>
        <th>Fármaco A</th>
        <th>Fármaco B</th>
        <th>Severidade</th>
        <th>Descrição</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const statusEl = document.getElementById('status');
    const table    = document.getElementById('resultsTable');
    const tbody    = table.querySelector('tbody');

    // 1) Nome → RxCUI
    async function getRxCUI(drug) {
      const url = 'https://rxnav.nlm.nih.gov/REST/rxcui.json?name='
                + encodeURIComponent(drug.trim());
      console.log('getRxCUI URL:', url);
      const res = await fetch(url);
      console.log('getRxCUI status:', res.status);
      const obj = await res.json();
      const ids = obj.idGroup?.rxnormId;
      if (!ids?.length) throw new Error(`"${drug}" não encontrado no RxNorm`);
      return ids[0];
    }

    // 2) Para CADA RxCUI chama interaction.json
    async function fetchInteractions(rxcuis) {
      const pairs = [];
      const seen  = new Set();

      for (const rxcui of rxcuis) {
        const url = `https://rxnav.nlm.nih.gov/REST/interaction/interaction.json`
                  + `?rxcui=${encodeURIComponent(rxcui)}`
                  + `&sources=ONCHigh,DrugBank`;
        console.log('fetchInteractions URL:', url);

        const res = await fetch(url);
        console.log('fetchInteractions status:', res.status);
        if (!res.ok) {
          console.warn(`  RxCUI ${rxcui} → ${res.statusText}`);
          continue;
        }
        const data = await res.json();
        if (!data.interactionTypeGroup) continue;

        for (const group of data.interactionTypeGroup) {
          for (const it of group.interactionType) {
            const [c1, c2] = it.minConcept;
            const r1 = c1.rxcui, r2 = c2.rxcui;
            // Só pares onde AMBOS estão na lista original
            if (!rxcuis.includes(r1) || !rxcuis.includes(r2)) continue;
            const key = [r1, r2].sort().join('-');
            if (seen.has(key)) continue;
            seen.add(key);
            pairs.push({
              a:        c1.name,
              b:        c2.name,
              severity: it.interactionPair[0].severity,
              desc:     it.interactionPair[0].description
            });
          }
        }
      }

      return pairs;
    }

    // 3) Listener do botão
    document.getElementById('checkBtn').addEventListener('click', async () => {
      statusEl.textContent = '';
      statusEl.className   = '';
      tbody.innerHTML      = '';
      table.hidden         = true;

      const drugs = document.getElementById('drugsInput').value
                     .split('\n')
                     .map(s => s.trim())
                     .filter(Boolean);

      if (drugs.length < 2) {
        statusEl.textContent = 'Digite pelo menos duas drogas.';
        statusEl.className   = 'error';
        return;
      }

      try {
        statusEl.textContent = 'Buscando códigos RxCUI…';
        const rxcuis = await Promise.all(drugs.map(getRxCUI));

        statusEl.textContent = 'Consultando interações…';
        const interactions = await fetchInteractions(rxcuis);

        if (interactions.length === 0) {
          statusEl.textContent = 'Nenhuma interação encontrada.';
          return;
        }

        interactions.forEach(i => {
          tbody.insertAdjacentHTML('beforeend', `
            <tr>
              <td>${i.a}</td>
              <td>${i.b}</td>
              <td>${i.severity}</td>
              <td>${i.desc}</td>
            </tr>`);
        });

        table.hidden = false;
        statusEl.textContent = `Encontradas ${interactions.length} interações.`;
      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.className   = 'error';
      }
    });
  </script>
</body>
</html>
