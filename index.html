<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Drug Interaction Checker</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    textarea { width: 100%; height: 80px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #bbb; padding: 0.5rem; text-align: left; }
    th { background: #eee; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Verificar Interações</h1>
  <p>Digite um fármaco por linha (ex: cannabidiol):</p>
  <textarea id="drugsInput" placeholder="cannabidiol&#10;warfarin"></textarea>
  <button id="checkBtn">Verificar Interações</button>
  <p id="status"></p>
  <table id="resultsTable" hidden>
    <thead>
      <tr>
        <th>Fármaco A</th>
        <th>Fármaco B</th>
        <th>Severidade</th>
        <th>Descrição</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const statusEl = document.getElementById('status');
    const table    = document.getElementById('resultsTable');
    const tbody    = table.querySelector('tbody');

    // 1) Mapeia nome para RxCUI
    async function getRxCUI(drug) {
      const res = await fetch(
        'https://rxnav.nlm.nih.gov/REST/rxcui.json?name='
        + encodeURIComponent(drug.trim())
      );
      const data = await res.json();
      const ids  = data.idGroup?.rxnormId;
      if (!ids || ids.length === 0) {
        throw new Error(`"${drug}" não encontrado`);
      }
      return ids[0];
    }

    // 2) Consulta interações, agora com encodeURIComponent para evitar erros de padrão
    async function fetchInteractions(rxcuis) {
      const rxcuisParam  = encodeURIComponent(rxcuis.join('+'));
      const sourcesParam = encodeURIComponent('ONCHigh,DrugBank');
      const url = `https://rxnav.nlm.nih.gov/REST/interaction/list.json`
                + `?rxcuis=${rxcuisParam}`
                + `&sources=${sourcesParam}`;

      const res  = await fetch(url);
      const data = await res.json();
      if (data.error) {
        throw new Error(data.error);
      }

      return data
        .interactionTypeGroup
        .flatMap(group => group.fullInteractionTypeGroup || [])
        .flatMap(g =>
          g.interactionType.map(it => ({
            a:        it.minConcept[0].name,
            b:        it.minConcept[1].name,
            severity: it.interactionPair[0].severity,
            desc:     it.interactionPair[0].description
          }))
        );
    }

    // 3) Listener do botão
    document.getElementById('checkBtn').addEventListener('click', async () => {
      statusEl.textContent = '';
      statusEl.className   = '';
      tbody.innerHTML      = '';
      table.hidden         = true;

      const drugs = document.getElementById('drugsInput').value
                     .split('\n')
                     .map(s => s.trim())
                     .filter(Boolean);

      if (drugs.length < 2) {
        statusEl.textContent = 'Digite pelo menos duas drogas.';
        statusEl.className   = 'error';
        return;
      }

      try {
        statusEl.textContent = 'Buscando RxCUI…';
        const rxcuis = await Promise.all(drugs.map(getRxCUI));

        statusEl.textContent = 'Consultando interações…';
        const interactions = await fetchInteractions(rxcuis);

        if (!interactions || interactions.length === 0) {
          statusEl.textContent = 'Nenhuma interação encontrada.';
          return;
        }

        // Preenche a tabela
        interactions.forEach(i => {
          const row = `<tr>
            <td>${i.a}</td>
            <td>${i.b}</td>
            <td>${i.severity}</td>
            <td>${i.desc}</td>
          </tr>`;
          tbody.insertAdjacentHTML('beforeend', row);
        });

        table.hidden = false;
        statusEl.textContent = `Encontradas ${interactions.length} interações.`;
      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.className   = 'error';
      }
    });
  </script>
</body>
</html>
